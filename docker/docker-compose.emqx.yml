# EMQX Docker Compose for AAS-UNS Bridge Interoperability Testing
#
# Usage:
#   docker compose -f docker/docker-compose.emqx.yml up -d
#
# EMQX Dashboard:
#   URL: http://localhost:18083
#   Username: admin
#   Password: public
#
# Run tests:
#   TEST_MQTT_HOST=localhost TEST_MQTT_PORT=1883 pytest tests/integration -v
#

services:
  emqx:
    image: emqx/emqx:5.5
    container_name: aas-uns-bridge-emqx
    ports:
      - "1883:1883"     # MQTT
      - "8083:8083"     # MQTT over WebSocket
      - "8084:8084"     # MQTT over WebSocket (SSL)
      - "8883:8883"     # MQTT SSL
      - "18083:18083"   # Dashboard
    environment:
      - EMQX_NAME=emqx
      - EMQX_HOST=127.0.0.1
      # Allow anonymous connections for testing
      - EMQX_ALLOW_ANONYMOUS=true
      # Enable MQTTv5
      - EMQX_MQTT__MAX_PACKET_SIZE=10MB
    healthcheck:
      test: ["CMD", "emqx", "ctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Optional: Add a test subscriber to verify messages
  mqtt-subscriber:
    image: eclipse-mosquitto:2
    container_name: aas-uns-bridge-subscriber
    depends_on:
      emqx:
        condition: service_healthy
    entrypoint: ["mosquitto_sub", "-h", "emqx", "-t", "#", "-v"]
    profiles:
      - debug
