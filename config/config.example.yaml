# AAS-UNS Bridge Configuration
# Copy this file to config.yaml and adjust values as needed.

mqtt:
  host: localhost
  port: 1883
  client_id: aas-uns-bridge
  # username: bridge_user
  # password: secret
  use_tls: false
  # ca_cert: /path/to/ca.crt
  # client_cert: /path/to/client.crt
  # client_key: /path/to/client.key
  keepalive: 60
  reconnect_delay_min: 1.0
  reconnect_delay_max: 120.0

uns:
  enabled: true
  root_topic: ""  # Leave empty for no prefix, or set to e.g. "uns"
  qos: 1
  retain: true

sparkplug:
  enabled: true
  group_id: AAS
  edge_node_id: Bridge
  device_prefix: ""
  qos: 0

file_watcher:
  enabled: true
  watch_dir: ./watch
  patterns:
    - "*.aasx"
    - "*.json"
  recursive: true
  debounce_seconds: 2.0

repo_client:
  enabled: false
  base_url: http://localhost:8080
  poll_interval_seconds: 60.0
  timeout_seconds: 30.0
  # auth_token: your-api-token

state:
  db_path: ./state/bridge.db
  cache_births: true
  deduplicate_publishes: true

observability:
  log_level: INFO
  log_format: console  # or "json" for production
  metrics_port: 9090
  health_port: 8080

# Preferred language for MultiLanguageProperty values
preferred_language: en

# Semantic enforcement configuration
# Transforms the bridge from a passive translator into a semantic enforcement layer
semantic:
  # Semantic QoS level:
  #   0 = Raw pass-through (no validation/enrichment)
  #   1 = Validated (schema validation before publish)
  #   2 = Enriched (validated + MQTT v5 User Properties)
  sqos_level: 0

  # Include metadata in MQTT v5 User Properties (headers)
  # Reduces payload size and enables header-based filtering on modern brokers
  use_user_properties: false

  # Keep metadata in JSON payload for compatibility with non-v5 subscribers
  # Only relevant when use_user_properties is true
  payload_metadata_fallback: true

  # Pre-publish validation settings
  validation:
    enabled: false

    # Require semantic IDs on elements
    enforce_semantic_ids: true

    # AAS element types that require semantic IDs
    required_for_types:
      - Property
      - Range

    # Reject invalid metrics (true) or warn only (false)
    reject_invalid: false

    # Value constraints keyed by semantic ID (IRDI/IRI)
    # Example: Temperature sensor constraint
    # value_constraints:
    #   "0173-1#02-AAO677#002":
    #     min: -40
    #     max: 120
    #     unit: "degC"
    #   "0173-1#02-AAH880#002":
    #     pattern: "^[A-Z]{2}[0-9]{6}$"  # Serial number format
    value_constraints: {}

  # Schema drift detection
  drift:
    enabled: false

    # Detect new metrics added to assets
    track_additions: true

    # Detect metrics removed from assets
    track_removals: true

    # Detect changes in value_type, unit, or semantic_id
    track_type_changes: true

    # Topic template for drift alerts ({asset_id} is replaced)
    alert_topic_template: "UNS/Sys/DriftAlerts/{asset_id}"

  # Asset lifecycle tracking
  lifecycle:
    enabled: false

    # Time (seconds) after which an asset without data is considered stale
    stale_threshold_seconds: 300

    # Clear retained messages when asset goes offline
    # WARNING: This permanently removes the asset's last known state
    clear_retained_on_offline: false

    # Publish lifecycle events to UNS/Sys/Lifecycle/{asset_id}
    publish_lifecycle_events: true
