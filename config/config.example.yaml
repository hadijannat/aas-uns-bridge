# AAS-UNS Bridge Configuration
# Copy this file to config.yaml and adjust values as needed.

mqtt:
  host: localhost
  port: 1883
  client_id: aas-uns-bridge
  # username: bridge_user
  # password: secret
  use_tls: false
  # ca_cert: /path/to/ca.crt
  # client_cert: /path/to/client.crt
  # client_key: /path/to/client.key
  keepalive: 60
  reconnect_delay_min: 1.0
  reconnect_delay_max: 120.0

uns:
  enabled: true
  root_topic: ""  # Leave empty for no prefix, or set to e.g. "uns"
  qos: 1
  retain: true

sparkplug:
  enabled: true
  group_id: AAS
  edge_node_id: Bridge
  device_prefix: ""
  qos: 0

file_watcher:
  enabled: true
  watch_dir: ./watch
  patterns:
    - "*.aasx"
    - "*.json"
  recursive: true
  debounce_seconds: 2.0

repo_client:
  enabled: false
  base_url: http://localhost:8080
  poll_interval_seconds: 60.0
  timeout_seconds: 30.0
  # auth_token: your-api-token

state:
  db_path: ./state/bridge.db
  cache_births: true
  deduplicate_publishes: true

observability:
  log_level: INFO
  log_format: console  # or "json" for production
  metrics_port: 9090
  health_port: 8080

# Preferred language for MultiLanguageProperty values
preferred_language: en

# Semantic enforcement configuration
# Transforms the bridge from a passive translator into a semantic enforcement layer
semantic:
  # Semantic QoS level:
  #   0 = Raw pass-through (no validation/enrichment)
  #   1 = Validated (schema validation before publish)
  #   2 = Enriched (validated + MQTT v5 User Properties)
  sqos_level: 0

  # Include metadata in MQTT v5 User Properties (headers)
  # Reduces payload size and enables header-based filtering on modern brokers
  use_user_properties: false

  # Keep metadata in JSON payload for compatibility with non-v5 subscribers
  # Only relevant when use_user_properties is true
  payload_metadata_fallback: true

  # Pre-publish validation settings
  validation:
    enabled: false

    # Require semantic IDs on elements
    enforce_semantic_ids: true

    # AAS element types that require semantic IDs
    required_for_types:
      - Property
      - Range

    # Reject invalid metrics (true) or warn only (false)
    reject_invalid: false

    # Value constraints keyed by semantic ID (IRDI/IRI)
    # Example: Temperature sensor constraint
    # value_constraints:
    #   "0173-1#02-AAO677#002":
    #     min: -40
    #     max: 120
    #     unit: "degC"
    #   "0173-1#02-AAH880#002":
    #     pattern: "^[A-Z]{2}[0-9]{6}$"  # Serial number format
    value_constraints: {}

  # Schema drift detection
  drift:
    enabled: false

    # Detect new metrics added to assets
    track_additions: true

    # Detect metrics removed from assets
    track_removals: true

    # Detect changes in value_type, unit, or semantic_id
    track_type_changes: true

    # Topic template for drift alerts ({asset_id} is replaced)
    alert_topic_template: "UNS/Sys/DriftAlerts/{asset_id}"

  # Asset lifecycle tracking
  lifecycle:
    enabled: false

    # Time (seconds) after which an asset without data is considered stale
    stale_threshold_seconds: 300

    # Clear retained messages when asset goes offline
    # WARNING: This permanently removes the asset's last known state
    clear_retained_on_offline: false

    # Publish lifecycle events to UNS/Sys/Lifecycle/{asset_id}
    publish_lifecycle_events: true

# Semantic hypervisor configuration
# Advanced features for semantic context management and closed-loop control
hypervisor:
  # Semantic resolution cache for pointer mode payload optimization
  resolution_cache:
    enabled: false
    # Maximum entries in memory LRU cache
    max_memory_entries: 10000
    # Preload existing entries from database on startup
    preload_on_startup: true

  # Pointer mode: reduces payload overhead by ~90% using hash references
  pointer:
    enabled: false
    # Payload mode: "inline" (full metadata), "pointer" (hash only), "hybrid" (pointer + minimal)
    mode: inline
    # Publish semantic contexts to dedicated topics for consumer resolution
    publish_context_topics: true
    # Topic prefix for context publication
    context_topic_prefix: "UNS/Sys/Context"

  # Information-theoretic fidelity metrics
  fidelity:
    enabled: false
    # Alert threshold for low fidelity (0.0 - 1.0)
    alert_threshold: 0.7
    # Weights for overall fidelity score calculation
    weights:
      structural: 0.3
      semantic: 0.5
      entropy: 0.2

  # Streaming drift detection with Half-Space Trees
  incremental_drift:
    enabled: false
    # Reference window size for anomaly detection
    window_size: 1000
    # Number of Half-Space Trees in ensemble
    num_trees: 25
    # Severity thresholds for anomaly scores
    severity_thresholds:
      low: 0.3
      medium: 0.5
      high: 0.7
      critical: 0.9

  # Bidirectional sync: MQTT command write-back to AAS repository
  bidirectional:
    enabled: false
    # AAS repository URL for write operations
    aas_repository_url: http://localhost:8080
    # Optional authentication token
    # auth_token: your-api-token
    # Topic suffix identifying command topics
    command_topic_suffix: /cmd
    # Glob patterns for allowed write paths
    allowed_write_patterns:
      - "Setpoints/*"
      - "Configuration/*"
    # Glob patterns for denied write paths (takes precedence)
    denied_write_patterns:
      - "readonly/*"
      - "Identification/*"
    # Validate writes before executing
    validate_before_write: true
    # Publish ack/nak confirmations
    publish_confirmations: true
